services:
  app:
    build: .
    environment:
      - DATABASE_URL=${DATABASE_URL:-file:/app/data/dev.db}
      - JWT_SECRET=${JWT_SECRET:-changethis}
      - DISABLE_EMAIL_CONFIRMATION=${DISABLE_EMAIL_CONFIRMATION:-true}
    volumes:
      - ./data:/app/data
      - ./uploads:/app/public/uploads
    restart: always

  collaboration:
    build: .
    command: npm run start:collab
    environment:
      - DATABASE_URL=${DATABASE_URL:-file:/app/data/dev.db}
    ports:
      - "1234:1234"
    volumes:
      - ./data:/app/data
    restart: always

  nginx:
    image: nginx:alpine
    command: |
      sh -c "apk add --no-cache openssl >/dev/null && \
      if [ ! -f /etc/nginx/certs/server.key ] || [ ! -f /etc/nginx/certs/server.crt ]; then \
        echo 'Generating self-signed certificate...'; \
        mkdir -p /etc/nginx/certs && \
        openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /etc/nginx/certs/server.key -out /etc/nginx/certs/server.crt -subj '/C=US/ST=State/L=City/O=Pesky/CN=localhost'; \
      fi && \
      nginx -g 'daemon off;'"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./certs:/etc/nginx/certs
      - ./public/uploads:/usr/share/nginx/html/uploads:ro
    depends_on:
      - app
      - collaboration
    restart: always
